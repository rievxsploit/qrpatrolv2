<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Patrol</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-md mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-4">QR Patrol</h1>

    <!-- Login Form -->
    <div id="login-section" class="space-y-2">
      <input type="email" id="email" placeholder="Email" class="w-full p-2 border rounded">
      <input type="password" id="password" placeholder="Password" class="w-full p-2 border rounded">
      <button onclick="login()" class="w-full bg-blue-500 text-white p-2 rounded">Login</button>
    </div>

    <!-- QR Scanner Section -->
    <div id="scanner-section" class="hidden space-y-4">
      <div id="qr-reader" class="w-full"></div>
      <button onclick="logout()" class="w-full bg-red-500 text-white p-2 rounded">Logout</button>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-bold mb-2">Scan Log</h2>
        <ul id="log-list" class="space-y-1 text-sm"></ul>
      </div>
    </div>
  </div>

  <script src="firebase-config.js"></script>
  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('scanner-section').classList.remove('hidden');
        startScanner();
        loadLogs();
      } else {
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('scanner-section').classList.add('hidden');
      }
    });

    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(e => alert(e.message));
    }

    function logout() {
      auth.signOut();
    }

    function startScanner() {
      const qrScanner = new Html5Qrcode("qr-reader");
      const config = { fps: 10, qrbox: 250 };
      Html5Qrcode.getCameras().then(devices => {
        const backCam = devices.find(d => d.label.toLowerCase().includes('back')) || devices[0];
        qrScanner.start(backCam.id, config, async qrCodeMessage => {
          await logScan(qrCodeMessage);
        });
      });
    }

    async function logScan(data) {
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        const { latitude, longitude } = position.coords;
        const timestamp = new Date();
        const user = auth.currentUser;

        await db.collection("logs").add({
          userId: user.uid,
          userEmail: user.email,
          qrCode: data,
          timestamp,
          location: { lat: latitude, lng: longitude }
        });
        loadLogs();
      } catch (err) {
        alert("Location error: " + err.message);
      }
    }

    function loadLogs() {
      const user = auth.currentUser;
      db.collection("logs").where("userId", "==", user.uid)
        .orderBy("timestamp", "desc")
        .limit(10).get().then(snapshot => {
          const list = document.getElementById("log-list");
          list.innerHTML = "";
          snapshot.forEach(doc => {
            const log = doc.data();
            const li = document.createElement("li");
            li.textContent = `${log.qrCode} - ${new Date(log.timestamp.seconds * 1000).toLocaleString()}
(${log.userEmail})`;
            list.appendChild(li);
          });
        });
    }
  </script>
</body>
</html>
